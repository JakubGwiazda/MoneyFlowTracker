<div class="table-wrapper">
  @if (loading()) {
    <div class="loading-overlay">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Ładowanie kategorii...</p>
    </div>
  }

  @if (!loading() && data().length === 0) {
    <div class="empty-state">
      <mat-icon class="empty-icon">category</mat-icon>
      <h3>Brak kategorii</h3>
      <p>Dodaj pierwszą kategorię, aby móc klasyfikować wydatki.</p>
    </div>
  }

  @if (data().length > 0) {
    <div class="table-container">
      <table
        mat-table
        [dataSource]="visibleRows()"
        class="categories-table"
        data-testid="categories-table">
        <!-- Name Column with Tree Structure -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Nazwa</th>
          <td mat-cell *matCellDef="let node" [class.child-row]="node.level > 0">
            <div class="category-name" [style.padding-left.px]="node.level * 24">
              @if (node.hasChildren) {
                <button
                  mat-icon-button
                  class="expand-button d-flex justify-content-center align-items-center"
                  (click)="toggleExpand(node.id)">
                  <mat-icon>
                    @if (node.isExpanded) {
                      expand_more
                    } @else {
                      chevron_right
                    }
                  </mat-icon>
                </button>
              } @else {
                <span class="expand-placeholder"></span>
              }
              <strong>{{ node.name }}</strong>
            </div>
          </td>
        </ng-container>

        <!-- Level indicator (hidden column for tree structure) -->
        <ng-container matColumnDef="level">
          <th mat-header-cell *matHeaderCellDef>Poziom</th>
          <td mat-cell *matCellDef="let node">
            @if (node.level === 0) {
              <span class="text-muted">Główna</span>
            } @else {
              <span class="text-muted">Poziom {{ node.level }}</span>
            }
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let node">
            <app-badge [label]="node.statusLabel" [tone]="node.statusTone" />
          </td>
        </ng-container>

        <!-- Usage Column -->
        <ng-container matColumnDef="usage">
          <th mat-header-cell *matHeaderCellDef>Użycie</th>
          <td mat-cell *matCellDef="let node">
            <div class="usage-cell">
              @if (node.usageCount && node.usageCount > 0) {
                <span class="usage-count">{{ node.usageCount }}</span>
                <span class="text-muted">wydatków</span>
              } @else {
                <span class="text-muted">Nieużywana</span>
              }
            </div>
          </td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef>Data utworzenia</th>
          <td mat-cell *matCellDef="let node">
            {{ node.created_at | date: 'dd.MM.yyyy' }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header">Akcje</th>
          <td mat-cell *matCellDef="let node" class="actions-cell">
            <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Więcej akcji">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="editCategory.emit(node.id)">
                <mat-icon>edit</mat-icon>
                <span>Edytuj</span>
              </button>
              <button
                mat-menu-item
                (click)="toggleActive.emit(node.id)"
                [disabled]="node.usageCount > 0 || node.hasChildren">
                <mat-icon>
                  @if (node.is_active) {
                    visibility_off
                  } @else {
                    visibility
                  }
                </mat-icon>
                <span>
                  @if (node.is_active) {
                    Dezaktywuj
                  } @else {
                    Aktywuj
                  }
                </span>
              </button>
              <button
                mat-menu-item
                (click)="deleteCategory.emit(node.id)"
                [disabled]="node.usageCount > 0 || node.hasChildren">
                <mat-icon>delete</mat-icon>
                <span>Usuń</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
  }
</div>
